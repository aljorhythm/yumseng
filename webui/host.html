<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <title>Cheers To Life</title>

    <!-- Latest compiled and minified CSS -->
    <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
            integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
            crossorigin="anonymous"
    />
    <!-- Optional theme -->
    <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
            integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
            crossorigin="anonymous"
    />

    <link rel="stylesheet" href="style.css"/>
</head>

<body>
<div class="container">
    <div id="interact"
         style="position: fixed; top: 0; left: 0; background: white; width: 100vw; height: 100vh; text-align: center; z-index: 100">
        <button class="btn btn-info" onclick="document.querySelector('#interact').remove()">
            ENTER
        </button>
        <a href="/">client</a>
    </div>

    <div style="float: left; display: none"
         id="bearmug"
         class="yumseng-img">
        <img class="img-fluid" src="face_1.jpg"/>
    </div>

    <div class="row" id="cheers">

        <style>
            #container-1 {
                display: flex;
                flex-direction: row;
                justify-content: space-around;
            }

            #beer-img-container {
                position: relative;
                height: 80vh;
                background: rgba(252, 3, 3, 0.7);
                border-radius: 4px;
            }
        </style>

        <div id="container-1">
            <div style="width: 80%" id="beer-img-container"></div>
            <div style="width: 10%" id="leaderboard-container">
                <h2>Leaderboard</h2>
                <div v-for="scorer in topScorers">
                    <span>{{scorer.user_id}}</span>
                    <span>{{scorer.points}}</span>
                </div>
            </div>
        </div>


        <style>
            .yumseng-img img {
                width: 100px;
                border-radius: 10px;
            }
        </style>

        <div style="display: none">
            <audio loop volume="0" controls autoplay id="yum-audio">
                <source src="yuuuuuuuuum.mp3" type="audio/mp3"/>
                Your browser does not support the audio tag.
            </audio>

            <audio volume="0" controls autoplay id="seng-audio">
                <source src="seng.mp3" type="audio/mp3"/>
                Your browser does not support the audio tag.
            </audio>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<!-- Latest compiled and minified JavaScript -->
<script
        src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"
></script>

<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>

</body>

<script type="application/javascript">

    function log(args) {
        // console.log(args)
    }

    function randomInteger(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    const yumButton = document.getElementById("yum-button");

    const dummyUserId = "global-user";
    const dummyRoomName = "global-room";


    function playSeng() {
        const sengAudio = document.getElementById("seng-audio");
        sengAudio.play()
    }

    (function () {
        const yumAudio = document.getElementById("yum-audio");
        yumAudio.volume = 0
    })()

    if (window["WebSocket"]) {
        websocketScheme =
            window.location.protocol == "http:" ? "ws://" : "wss://";
        const conn = new WebSocket(
            websocketScheme + document.location.host + "/rooms/events"
        );

        conn.onclose = (_) => {
            log("connection closed");
        };

        conn.onmessage = ({data}) => {
            log("onmessage event data", data);
            const event = JSON.parse(data);
            const eventName = event["event_name"];

            if (eventName == "EVENT_INTENSITY") {
                const intensity = event["intensity"];
                var cheersSpeedHtml = `<div>speed: ${intensity}</div>`;
                $("#cheers-speed").empty().append(cheersSpeedHtml);
                const yumAudio = document.getElementById("yum-audio");
                const targetVolume = intensity
                yumAudio.volume -= (yumAudio.volume - targetVolume) / 1.8
                yumAudio.play();
            } else if (eventName == "EVENT_CHEER_ADDED") {
                const cheer = event["cheer"]
                if (cheer["value"] == "seng") {
                    playSeng()
                    return
                }
                const imageUrl = cheer["image_url"] || 'face_1.jpg'
                const $mug = $(`<div id=${Date.now()} class="yumseng-img">
                                    <img class="img-fluid" src="${imageUrl}"/>
                              </div>`);
                $mug.attr("id", "bearmug" + Date.now());

                const $container = $("#beer-img-container");

                $container.append($mug);
                $mug.css({
                    position: "absolute",
                });
                const randomLeft = randomInteger(
                    1,
                    $container.width() - $mug.width()
                );
                const randomTop = randomInteger(
                    1,
                    $container.height() - $mug.height()
                );

                $mug.css({
                    top: `${randomTop}px`,
                    left: `${randomLeft}px`,
                });

                $mug.fadeIn(600, () => {
                    $mug.fadeOut(600, () => {
                        $mug.remove();
                    });
                });
            }
        };

        conn.onopen = (_) => {
            log("connection opened");
            const userDetails = JSON.stringify({
                room_name: dummyRoomName,
                user_id: dummyUserId,
            });
            log("send first message (user info)", userDetails);
            conn.send(userDetails);
        };
    }

    var app = new Vue({
        el: '#leaderboard-container',
        data: {
            roomId: dummyRoomName,
            topScorers: []
        },
        methods: {
            async fetchLeaderboard() {
                const resp = await fetch(`/rooms/${this.roomId}/leaderboard`)
                this.topScorers = await resp.json()
            }
        },
        created() {
            setInterval(() => {
                this.fetchLeaderboard()
            }, 100)
        },
    })
</script>
</html>
